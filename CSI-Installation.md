| Step | Description | Commands/Actions | Notes |
|---|---|---|---|
| **1. Prerequisites** | Ensure OpenShift, `oc` CLI, Vault server, and Secrets Store CSI driver are ready. | - `oc get nodes` <br> - `oc whoami` <br> - Verify Vault reachability. <br> - Verify Secrets Store CSI driver installation. | `cluster-admin` required. Vault needs Kubernetes auth. |
| **2. Add Helm Repo (Providers)** | Add Secrets Store CSI Driver Providers Helm repo. | `helm repo add secrets-store-csi-driver-providers https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts` <br> `helm repo update` | Gets the Vault provider chart. |
| **3. Install Vault Provider** | Install the Vault provider via Helm. | `helm install csi-secrets-store-provider-vault secrets-store-csi-driver-providers/secrets-store-provider-vault -n vault-csi-driver` | Install in same namespace as CSI driver. |
| **4. Vault Kubernetes Auth Role** | Create Vault Kubernetes auth role. | `vault auth enable kubernetes` <br> `vault write auth/kubernetes/config kubernetes_host="..." kubernetes_ca_cert=@...` <br> `vault write auth/kubernetes/role/csi-driver ...` | Replace placeholders. Create `csi-driver-policy` in Vault. |
| **5. Vault Policy** | Create Vault policy for secret access. | `vault policy write csi-driver-policy - <<EOF ... EOF` | Adjust paths/capabilities. |
| **6. Service Account** | Create service account for CSI driver. | `oc create serviceaccount vault-csi-controller-sa -n vault-csi-driver` | Used for Vault authentication. |
| **7. SecretProviderClass (Vault)** | Define secret fetching from Vault. | Create `secretproviderclass-vault.yaml`: <br> ```yaml <br> apiVersion: secrets-store.csi.x-k8s.io/v1 <br> kind: SecretProviderClass <br> metadata: <br> name: vault-secrets <br> spec: <br> provider: vault <br> parameters: <br> vaultAddress: "..." <br> roleName: "csi-driver" <br> objects: <br> - secretName: my-secret <br> data: <br> - key: data.my-secret-value <br> objectName: secret/data/my-secret <br> ``` <br> `oc apply -f secretproviderclass-vault.yaml -n vault-csi-driver` | Replace placeholders. `vaultAddress`, `roleName`, `objects` are crucial. |
| **8. Mount Secrets in Pods** | Mount secrets using `SecretProviderClass`. | Pod YAML: <br> ```yaml <br> volumes: <br> - name: secrets <br> csi: <br> driver: secrets-store.csi.k8s.io <br> readOnly: true <br> volumeAttributes: <br> secretProviderClass: "vault-secrets" <br> ``` | Secrets mounted as files. |
| **9. Verify Secret Access** | Check pod logs/mounted files. Verify secret creation. | `oc describe secret my-secret -n <pod-namespace>` | Check pod logs for secret values. |
| **10. Updating Secrets** | Vault secret updates reflect in pod. | N/A | Based on CSI driver sync frequency. |
